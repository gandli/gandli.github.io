name: Process Diary Entry

on:
  push:
    branches: ["main"]
    paths:
      - "content/posts/*.md"
  schedule:
    - cron: "0 */6 * * *" # every 6 hours, catch any missed posts
  workflow_dispatch:
    inputs:
      post_file:
        description: "Specific post (e.g., content/posts/2026-02-25-day7.md). Leave empty to auto-detect."
        required: false
      force:
        description: "Force regenerate all assets"
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "process-diary"
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      posts_to_process: ${{ steps.detect.outputs.posts_to_process }}
      has_work: ${{ steps.detect.outputs.has_work }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect posts needing processing
        id: detect
        run: |
          FORCE="${{ github.event.inputs.force }}"

          # If specific post given, use it
          if [ -n "${{ github.event.inputs.post_file }}" ]; then
            echo "posts_to_process=${{ github.event.inputs.post_file }}" >> $GITHUB_OUTPUT
            echo "has_work=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Scan ALL Chinese posts, find those missing assets
          NEEDS_WORK=""
          for POST in content/posts/*.zh.md; do
            BASENAME=$(basename "$POST" .zh.md)

            if [ "$FORCE" = "true" ]; then
              NEEDS_WORK="$NEEDS_WORK $POST"
              continue
            fi

            MISSING=""

            # Check summary in frontmatter
            grep -q '^summary:' "$POST" || MISSING="summary"

            # Check cover image
            [ -f "static/covers/${BASENAME}.jpg" ] || MISSING="$MISSING cover"

            # Check English version
            EN_FILE="content/posts/${BASENAME}.en.md"
            [ -f "$EN_FILE" ] || MISSING="$MISSING en"

            # Check Chinese audio
            [ -f "static/audio/${BASENAME}.zh.mp3" ] || MISSING="$MISSING audio_zh"

            # Check English audio
            [ -f "static/audio/${BASENAME}.en.mp3" ] || MISSING="$MISSING audio_en"

            if [ -n "$MISSING" ]; then
              echo "üìã $BASENAME missing:$MISSING"
              NEEDS_WORK="$NEEDS_WORK $POST"
            fi
          done

          NEEDS_WORK=$(echo "$NEEDS_WORK" | xargs)
          if [ -z "$NEEDS_WORK" ]; then
            echo "has_work=false" >> $GITHUB_OUTPUT
            echo "‚úÖ All posts have complete assets."
          else
            echo "posts_to_process=$NEEDS_WORK" >> $GITHUB_OUTPUT
            echo "has_work=true" >> $GITHUB_OUTPUT
            echo "üîß Posts to process: $NEEDS_WORK"
          fi

  process:
    needs: detect
    if: needs.detect.outputs.has_work == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install requests edge-tts
          sudo apt-get update -qq && sudo apt-get install -y -qq ffmpeg
          HUGO_VERSION=0.128.0
          wget -q -O /tmp/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb
          sudo dpkg -i /tmp/hugo.deb

      - name: Process each post (skip existing assets)
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          FORCE: ${{ github.event.inputs.force }}
        run: |
          for POST_FILE in ${{ needs.detect.outputs.posts_to_process }}; do
            echo "=== Processing: $POST_FILE ==="

            BASENAME=$(basename "$POST_FILE" .zh.md)
            DIR=$(dirname "$POST_FILE")

            EN_FILE="${DIR}/${BASENAME}.en.md"
            COVER_JPG="static/covers/${BASENAME}.jpg"
            AUDIO_ZH="static/audio/${BASENAME}.zh.mp3"
            AUDIO_EN="static/audio/${BASENAME}.en.mp3"

            # --- 1. Chinese Summary ---
            if [ "$FORCE" = "true" ] || ! grep -q '^summary:' "$POST_FILE"; then
              echo "üìù Generating Chinese summary..."
              python3 scripts/generate_summary.py "$POST_FILE" zh
            else
              echo "‚è≠Ô∏è Summary exists"
            fi

            # --- 2. Cover Image ---
            if [ "$FORCE" = "true" ] || ! [ -f "$COVER_JPG" ]; then
              echo "üé® Generating cover..."
              python3 scripts/generate_cover.py "$POST_FILE" || echo "‚ö†Ô∏è Cover failed"
            else
              echo "‚è≠Ô∏è Cover exists"
            fi

            # --- 3. English Translation ---
            if [ "$FORCE" = "true" ] || ! [ -f "$EN_FILE" ]; then
              echo "üåê Translating to English..."
              python3 scripts/translate_post.py "$POST_FILE" "$EN_FILE"
            else
              echo "‚è≠Ô∏è English version exists"
            fi

            # --- 4. Chinese Audio ---
            if [ "$FORCE" = "true" ] || ! [ -f "$AUDIO_ZH" ]; then
              echo "üîä Chinese audio..."
              python3 scripts/generate_audio.py "$POST_FILE" zh "$AUDIO_ZH" || echo "‚ö†Ô∏è Chinese TTS failed"
            else
              echo "‚è≠Ô∏è Chinese audio exists"
            fi

            # --- 5. English Audio ---
            if [ "$FORCE" = "true" ] || ! [ -f "$AUDIO_EN" ]; then
              if [ -f "$EN_FILE" ]; then
                echo "üîä English audio..."
                python3 scripts/generate_audio.py "$EN_FILE" en "$AUDIO_EN" || echo "‚ö†Ô∏è English TTS failed"
              fi
            else
              echo "‚è≠Ô∏è English audio exists"
            fi

            echo "=== Done: $POST_FILE ==="
          done

      - name: Commit processed files
        run: |
          git config user.name "Lobster Bot ü¶û"
          git config user.email "lobster@gandli.github.io"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ü¶û Auto-process: summary, cover, translation, audio [CF AI]"
            git pull --rebase origin main && git push
          fi

  build-deploy:
    needs: process
    if: always() && needs.process.result != 'skipped'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          ref: main

      - name: Pull latest
        run: git pull origin main

      - name: Install Hugo
        run: |
          HUGO_VERSION=0.128.0
          wget -q -O /tmp/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb
          sudo dpkg -i /tmp/hugo.deb

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Build with Hugo
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
        run: hugo --minify --baseURL "${{ steps.pages.outputs.base_url }}/"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
