name: Process Diary Entry

on:
  push:
    branches: ["main"]
    paths:
      - "content/posts/*.md"
  workflow_dispatch:
    inputs:
      post_file:
        description: "Post filename (e.g., 2026-02-25-day7.md)"
        required: false
      force:
        description: "Force regenerate all assets"
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "process-diary"
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      new_posts: ${{ steps.detect.outputs.new_posts }}
      has_new: ${{ steps.detect.outputs.has_new }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new Chinese diary posts
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.post_file }}" ]; then
            echo "new_posts=${{ github.event.inputs.post_file }}" >> $GITHUB_OUTPUT
            echo "has_new=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          NEW_POSTS=$(git diff --name-only HEAD~1 HEAD -- 'content/posts/*.md' | grep -v '\-en\.' | grep -v '\.en\.' || true)

          if [ -z "$NEW_POSTS" ]; then
            echo "has_new=false" >> $GITHUB_OUTPUT
            echo "No new Chinese posts found."
          else
            POSTS_LINE=$(echo "$NEW_POSTS" | tr '\n' ' ')
            echo "new_posts=$POSTS_LINE" >> $GITHUB_OUTPUT
            echo "has_new=true" >> $GITHUB_OUTPUT
            echo "New posts: $POSTS_LINE"
          fi

  process:
    needs: detect
    if: needs.detect.outputs.has_new == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install requests
          sudo apt-get update -qq && sudo apt-get install -y -qq ffmpeg
          HUGO_VERSION=0.128.0
          wget -q -O /tmp/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb
          sudo dpkg -i /tmp/hugo.deb

      - name: Process each post (skip existing assets)
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          FORCE: ${{ github.event.inputs.force }}
        run: |
          for POST_FILE in ${{ needs.detect.outputs.new_posts }}; do
            echo "=== Processing: $POST_FILE ==="

            BASENAME=$(basename "$POST_FILE" .md)
            DIR=$(dirname "$POST_FILE")

            if echo "$BASENAME" | grep -qE '\-en$|\.en$'; then
              echo "‚è≠Ô∏è Skipping English file: $POST_FILE"
              continue
            fi

            EN_FILE="${DIR}/${BASENAME}-en.md"
            COVER_FILE="static/covers/${BASENAME}.png"
            AUDIO_ZH="static/audio/${BASENAME}.mp3"
            AUDIO_EN="static/audio/${BASENAME}-en.mp3"

            # --- Helper: check if frontmatter has a field ---
            has_field() {
              grep -q "^$1:" "$2" 2>/dev/null
            }

            # --- 1. Chinese Summary ---
            if [ "$FORCE" = "true" ] || ! has_field summary "$POST_FILE"; then
              echo "üìù Generating Chinese summary..."
              python3 scripts/generate_summary.py "$POST_FILE" zh
            else
              echo "‚è≠Ô∏è Summary already exists"
            fi

            # --- 2. Cover Image ---
            if [ "$FORCE" = "true" ] || ! [ -f "$COVER_FILE" ]; then
              echo "üé® Generating cover image..."
              python3 scripts/generate_cover.py "$POST_FILE" || echo "‚ö†Ô∏è Cover generation failed"
            else
              echo "‚è≠Ô∏è Cover already exists: $COVER_FILE"
            fi

            # --- 3. English Translation ---
            if [ "$FORCE" = "true" ] || ! [ -f "$EN_FILE" ]; then
              echo "üåê Translating to English..."
              python3 scripts/translate_post.py "$POST_FILE" "$EN_FILE"
            else
              echo "‚è≠Ô∏è English version already exists: $EN_FILE"
            fi

            # --- 4. Chinese Audio ---
            if [ "$FORCE" = "true" ] || ! [ -f "$AUDIO_ZH" ]; then
              echo "üîä Generating Chinese audio..."
              python3 scripts/generate_audio.py "$POST_FILE" zh "$AUDIO_ZH" || echo "‚ö†Ô∏è Chinese TTS failed"
            else
              echo "‚è≠Ô∏è Chinese audio already exists: $AUDIO_ZH"
            fi

            # --- 5. English Audio ---
            if [ "$FORCE" = "true" ] || ! [ -f "$AUDIO_EN" ]; then
              if [ -f "$EN_FILE" ]; then
                echo "üîä Generating English audio..."
                python3 scripts/generate_audio.py "$EN_FILE" en "$AUDIO_EN" || echo "‚ö†Ô∏è English TTS failed"
              fi
            else
              echo "‚è≠Ô∏è English audio already exists: $AUDIO_EN"
            fi

            echo "=== Done: $POST_FILE ==="
          done

      - name: Commit processed files
        run: |
          git config user.name "Lobster Bot ü¶û"
          git config user.email "lobster@gandli.github.io"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ü¶û Auto-process: summary, cover, translation, audio [CF AI]"
            git push
          fi

  build-deploy:
    needs: process
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          ref: main

      - name: Pull latest
        run: git pull origin main

      - name: Install Hugo
        run: |
          HUGO_VERSION=0.128.0
          wget -q -O /tmp/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb
          sudo dpkg -i /tmp/hugo.deb

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Build with Hugo
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
        run: hugo --minify --baseURL "${{ steps.pages.outputs.base_url }}/"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
